<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é…’åº—äº¤æ¥ç®¡ç†ç³»çµ±</title>
  <style>
    :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f4f7f6; }
    body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 10px; margin: 0; }
    .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h3 { border-left: 6px solid var(--primary); padding-left: 12px; margin-top: 0; color: #333; }
    
    /* æ¨“å±¤å±•é–‹ç¶²æ ¼ - è§£æ±ºé è¦½çœ‹ä¸åˆ°å…¨éƒ¨çš„å•é¡Œ */
    .floor-grid { display: grid; grid-template-columns: 60px 100px 150px 150px 1fr 60px; gap: 8px; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
    
    /* ç¶­ä¿®è­¦ç¤ºç´…è‰²èƒŒæ™¯ */
    .repair-row { background-color: #fff1f0 !important; color: #cf1322; font-weight: bold; }
    
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #f8f9fa; }
    
    input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 95%; font-size: 14px; }
    .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; color: white; transition: 0.3s; }
    .btn-save { background: var(--primary); }
    .btn-line { background: var(--success); }
    .btn-bulk-del { background: var(--danger); float: right; margin-bottom: 10px; }
    
    @media (max-width: 768px) {
      .floor-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
      .floor-grid div:first-child { grid-column: span 2; background: #eee; padding: 5px; }
    }
  </style>
</head>
<body>

  <div class="card">
    <h3>ğŸ‘¤ äº¤æ¥äººå“¡è¨­å®š</h3>
    <select id="staffName">
      <option value="Jerry Manager">Jerry Manager</option>
      <option value="Linda Supervisor">Linda Supervisor</option>
      <option value="Kevin Staff">Kevin Staff</option>
      <option value="Alice Receptionist">Alice Receptionist</option>
    </select>
  </div>

  <div class="card">
    <h3>ğŸ§¹ æ´—åœ°æ¯¯ / ğŸ›ï¸ æ‹†ä½µåºŠ (æ¨“å±¤å…¨è¦½)</h3>
    <div class="floor-grid" style="font-weight: bold; background: #f8f9fa;">
      <div>æ¨“å±¤</div><div>é¡åˆ¥</div><div>é è¨ˆæ—¥æœŸ</div><div>å®Œæˆæ—¥æœŸ</div><div>å…§å®¹(æˆ¿è™Ÿ/ç‹€æ…‹)</div><div>å„²å­˜</div>
    </div>
    <div id="floorRows"></div>
  </div>

  <div class="card">
    <h3>ğŸ“¦è¡Œæ / ğŸš—æ¥é§ / ğŸ› ï¸ç¶­ä¿® / ğŸ“¢å…¶ä»–</h3>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <select id="quickCat" style="width: 150px;">
        <option value="ğŸ“¦ è¡Œæç‰©å“">ğŸ“¦ è¡Œæç‰©å“</option>
        <option value="ğŸš— æ¥é§æœå‹™">ğŸš— æ¥é§æœå‹™</option>
        <option value="ğŸ› ï¸ ç¶­ä¿®å ±ä¿®">ğŸ› ï¸ ç¶­ä¿®å ±ä¿®</option>
        <option value="ğŸ“¢ å…¶ä»–äº‹é …">ğŸ“¢ å…¶ä»–äº‹é …</option>
      </select>
      <input type="text" id="quickContent" placeholder="è¼¸å…¥ç´°ç¯€ (æ¥é§:åœ°é»/ç­æ¬¡/å¸æ©Ÿ | ç¶­ä¿®:è¨­å‚™æå£ç‹€æ³)" style="flex: 1;">
      <button class="btn btn-save" onclick="addQuick()">æ–°å¢ç´€éŒ„</button>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“œ æ­·å²ç´€éŒ„ (æœå°‹ / å‹¾é¸æ‰¹é‡åˆªé™¤ / å–®ç­†å‚³ Line)</h3>
    <div style="margin-bottom: 15px; overflow: hidden;">
      æœå°‹é¡åˆ¥ï¼š<select id="searchFilter" onchange="loadRecords()" style="width: 150px;">
        <option value="å…¨éƒ¨">å…¨éƒ¨é¡¯ç¤º</option>
        <option value="è¡Œæ">è¡Œæ</option><option value="æ¥é§">æ¥é§</option>
        <option value="ç¶­ä¿®">ç¶­ä¿®</option><option value="åœ°æ¯¯">æ´—åœ°æ¯¯</option>
      </select>
      <button class="btn btn-bulk-del" onclick="bulkDelete()">ğŸ—‘ï¸ æ‰¹é‡åˆªé™¤å‹¾é¸é …ç›®</button>
    </div>
    <table id="historyTable">
      <thead>
        <tr>
          <th width="40"><input type="checkbox" onclick="toggleAll(this)"></th>
          <th width="120">äº¤æ¥äºº</th><th width="120">åˆ†é¡</th><th>å…§å®¹ (é»æ“Šç›´æ¥æ”¹)</th><th width="80">é€šçŸ¥</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>

<script>
  // ä½ çš„ Apps Script ç¶²å€
  const API_URL = "https://script.google.com/macros/s/AKfycbylaLewrDfW_JM6sEvzm67M_tunU4olxba_sepW52NOndfMwGcVazmSiQbiZwYGotgK/exec";
  const floors = ['2F','3F','4F','5F','6F','7F','8F','9F'];

  window.onload = () => {
    const container = document.getElementById('floorRows');
    floors.forEach(f => {
      container.innerHTML += `
        <div class="floor-grid">
          <strong>${f} æ¨“</strong>
          <select id="c_${f}"><option value="ğŸ§¹æ´—åœ°æ¯¯">æ´—åœ°æ¯¯</option><option value="ğŸ›ï¸æ‹†ä½µåºŠ">æ‹†ä½µåºŠ</option></select>
          <input type="date" id="p_${f}">
          <input type="date" id="d_${f}">
          <input type="text" id="n_${f}" placeholder="æˆ¿è™Ÿ/é é€²ç©ºæˆ¿">
          <button class="btn btn-save" onclick="saveFloor('${f}')">å­˜</button>
        </div>`;
    });
    loadRecords();
  };

  function loadRecords() {
    fetch(API_URL + "?api=true").then(res => res.json()).then(data => {
      const filter = document.getElementById('searchFilter').value;
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = data.filter(r => filter === "å…¨éƒ¨" || r[3].includes(filter)).map(r => `
        <tr class="${r[3].includes('ç¶­ä¿®') ? 'repair-row' : ''}">
          <td><input type="checkbox" class="ck" value="${r[0]}"></td>
          <td>${r[2]}</td><td>${r[3]}</td>
          <td><input type="text" value="${r[4]}" onchange="updateInline('${r[0]}', this.value)"></td>
          <td><button class="btn btn-line" onclick="sendToLine('${r[3]}','${r[4]}')">Line</button></td>
        </tr>`).join('');
    });
  }

  function saveFloor(f) {
    const data = {
      staff: document.getElementById('staffName').value,
      cat: document.getElementById('c_'+f).value + '('+f+')',
      content: "é è¨ˆ:" + document.getElementById('p_'+f).value + " å®Œæˆ:" + document.getElementById('d_'+f).value + " èªªæ˜:" + document.getElementById('n_'+f).value
    };
    sendPost(data);
  }

  function addQuick() {
    const data = {
      staff: document.getElementById('staffName').value,
      cat: document.getElementById('quickCat').value,
      content: document.getElementById('quickContent').value
    };
    sendPost(data);
  }

  function updateInline(id, val) {
    sendPost({ action: "update_content", id: id, newContent: val });
  }

  function bulkDelete() {
    const ids = Array.from(document.querySelectorAll('.ck:checked')).map(c => c.value);
    if(ids.length > 0 && confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
      sendPost({ action: "batch_delete_history", ids: ids });
    }
  }

  function sendToLine(cat, content) {
    sendPost({ action: "send_line", cat: cat, content: content });
  }

  function sendPost(data) {
    fetch(API_URL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors' })
      .then(() => {
        setTimeout(loadRecords, 1000); // å»¶é²åˆ·æ–°ç¢ºä¿è³‡æ–™å¯«å…¥
      });
  }

  function toggleAll(s) { document.querySelectorAll('.ck').forEach(c => c.checked = s.checked); }
</script>
</body>
</html>
